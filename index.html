<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PyCon JP 2025 Live</title>
<link rel="stylesheet" href="style.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
</head>
<body>

<header class="main-header">
    <h1 class="page-title">PyCon JP 2025 Live</h1>
    <div class="header-actions">
        <a id="purchase-btn" href="https://pretix.eu/pyconjp/2025/" class="btn btn-primary" target="_blank">視聴チケット購入</a>
        <button id="get-rights-btn" class="btn btn-secondary">視聴権利の取得</button>
    </div>
</header>

<main class="player-grid-container">
    <!-- トラックはここに動的生成 -->
</main>

<script>
const CLIENT_ID = "i0VwMUzGedRaeEq1OVFZ7ez9XGnKeptlTOEK5Nlr";
const REDIRECT_URI = "https://auth.streamtech.cloud/callback";

// URLからトークンを取得
const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');

// JWTデコード（安全化）
function decodeJwt(token) {
    if (!token) return null;
    try {
        const payloadBase64 = token.split('.')[1];
        const payload = JSON.parse(atob(payloadBase64));
        return payload;
    } catch (e) {
        console.error("JWTデコード失敗", e);
        return null;
    }
}

// 動画再生セット
function setVideoSource(video, url) {
    if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
            video.controls = true;
        });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => video.controls = true);
    } else {
        console.error("HLS非対応ブラウザ");
    }
}

// トラックごとのプレイヤー生成
function createTrack(trackId, title, streamUUID) {
    const container = document.createElement('div');
    container.className = 'player-container';
    
    const h3 = document.createElement('h3');
    h3.className = 'track-title';
    h3.textContent = title;
    
    const video = document.createElement('video');
    video.id = trackId;
    video.poster = 'poster.png';
    video.controls = false;
    
    const btn = document.createElement('button');
    btn.textContent = '再生';
    btn.disabled = true; // 初期は無効化
    btn.addEventListener('click', async () => {
        if (!token) return alert("トークンがありません");
        try {
            btn.disabled = true;
            btn.textContent = '再生準備中...';
            const response = await fetch('https://auth.streamtech.cloud/get-stream-url', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ token, stream_id: streamUUID })
            });
            if (!response.ok) throw new Error('ストリーム取得失敗');
            const data = await response.json();
            setVideoSource(video, data.playback_url);
            btn.textContent = '再生中';
        } catch (e) {
            console.error("ストリーム取得エラー", e);
            alert("再生に失敗しました。コンソール確認");
            btn.textContent = '再生';
            btn.disabled = false;
        }
    });

    container.appendChild(h3);
    container.appendChild(video);
    container.appendChild(btn);
    document.querySelector('.player-grid-container').appendChild(container);
}

// ページ初期化
window.onload = () => {
    const payload = decodeJwt(token);
    const getRightsBtn = document.getElementById('get-rights-btn');
    const purchaseBtn = document.getElementById('purchase-btn');

    // トークンなし、またはデコード失敗時
    if (!payload) {
        console.warn("トークンが存在しないか不正です。");
        getRightsBtn.style.display = "inline-block";
        purchaseBtn.style.pointerEvents = 'auto';
        return;
    }

    const jstreamTracks = payload.jstream_registered_tracks || {};
    const tracks = Object.entries(jstreamTracks).map(([uuid, _], idx) => ({
        trackId: `track${idx+1}`,
        streamUUID: uuid
    }));

    tracks.forEach(t => createTrack(t.trackId, t.trackId, t.streamUUID));

    if (payload.has_ticket) {
        purchaseBtn.style.pointerEvents = 'none';
        purchaseBtn.style.opacity = 0.5;
        getRightsBtn.style.display = 'none';
        // 再生ボタンを有効化
        tracks.forEach(t => {
            const btn = document.querySelector(`#${t.trackId} + button`);
            if (btn) btn.disabled = false;
        });
    }

    getRightsBtn.addEventListener('click', () => {
        if (!token) {
            const url = new URL('https://pretix.eu/pyconjp/oauth2/v1/authorize');
            url.searchParams.set('client_id', CLIENT_ID);
            url.searchParams.set('response_type', 'code');
            url.searchParams.set('scope', 'openid profile email');
            url.searchParams.set('redirect_uri', REDIRECT_URI);
            window.location.href = url.toString();
        }
    });
};
</script>

</body>
</html>
