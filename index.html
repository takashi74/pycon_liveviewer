<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PyCon JP 2025 Live</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Shaka Player CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.4.0/shaka-player.compiled.js"></script>

<style>
:root {
    --main-bg-color: #f9f9f9;
    --card-bg-color: #ffffff;
    --text-color: #333333;
    --heading-color: #1a1a1a;
    --primary-btn-bg: #ff9da5;
    --primary-btn-hover-bg: #e68a91;
    --secondary-btn-bg: #24a53d;
    --secondary-btn-hover-bg: #1e8430;
    --border-color: #e0e0e0;
    --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.05);
    --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
    --border-radius: 6px;
}

body {
    font-family: 'IBM Plex Sans JP', sans-serif;
    background-color: var(--main-bg-color);
    margin: 0;
    padding: 30px 20px;
    color: var(--text-color);
    line-height: 1.6;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.main-header {
    text-align: center;
    margin-bottom: 50px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.page-title {
    font-size: 2.8rem;
    font-weight: 700;
    color: var(--heading-color);
    margin-bottom: 25px;
    letter-spacing: -0.02em;
}

.header-actions {
    display: flex;
    justify-content: center;
    gap: 25px;
}

.btn {
    padding: 14px 28px;
    font-size: 1.1rem;
    font-weight: 500;
    color: white;
    border: none;
    border-radius: var(--border-radius);
    text-decoration: none;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: var(--shadow-light);
}

.btn-primary {
    background-color: var(--primary-btn-bg);
}
.btn-primary:hover {
    background-color: var(--primary-btn-hover-bg);
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.btn-secondary {
    background-color: var(--secondary-btn-bg);
}
.btn-secondary:hover {
    background-color: var(--secondary-btn-hover-bg);
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.player-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
    gap: 30px;
    max-width: 1280px;
    margin: 0 auto;
    flex-grow: 1;
    padding: 20px 0;
}

.player-container {
    background-color: var(--card-bg-color);
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-medium);
    text-align: center;
    position: relative;
}

.track-title {
    margin: 0 0 15px 0;
    font-size: 1.5rem;
    font-weight: 500;
    color: var(--heading-color);
}

video {
    width: 100%;
    height: auto;
    min-height: 250px;
    border-radius: var(--border-radius);
    background-color: #000;
}

@media (max-width: 768px) {
    .main-header {
        margin-bottom: 30px;
    }
    .page-title {
        font-size: 2rem;
        margin-bottom: 15px;
    }
    .header-actions {
        flex-direction: column;
        gap: 15px;
    }
    .btn {
        width: 80%;
        margin: 0 auto;
    }
    .player-grid-container {
        grid-template-columns: 1fr;
        gap: 25px;
        padding: 10px 0;
    }
    .player-container {
        padding: 20px;
    }
    .track-title {
        font-size: 1.3rem;
    }
}
</style>
</head>
<body>

<header class="main-header">
    <h1 class="page-title">PyCon JP 2025 Live</h1>
    <div class="header-actions">
        <a id="purchase-btn" href="https://pretix.eu/pyconjp/2025/" class="btn btn-primary" target="_blank">視聴チケット購入</a>
        <button id="get-rights-btn" class="btn btn-secondary">視聴権利の取得</button>
    </div>
</header>

<main class="player-grid-container">
    <!-- プレイヤーはここに動的生成 -->
</main>

<script>
const CLIENT_ID = "i0VwMUzGedRaeEq1OVFZ7ez9XGnKeptlTOEK5Nlr";
const REDIRECT_URI = "https://auth.streamtech.cloud/callback";

const urlParams = new URLSearchParams(window.location.search);
const token = urlParams.get('token');
const is_debug = urlParams.get('is_debug') === '1';

function decodeJwt(token) {
    if (!token) return null;
    try {
        const payloadBase64 = token.split('.')[1];
        return JSON.parse(atob(payloadBase64));
    } catch (e) {
        console.error("JWTデコード失敗", e);
        return null;
    }
}

function createTrack(trackId, title, posterFile) {
    const container = document.createElement('div');
    container.className = 'player-container';

    const h3 = document.createElement('h3');
    h3.className = 'track-title';
    h3.textContent = title;

    const video = document.createElement('video');
    video.id = trackId;
    video.poster = posterFile;
    video.controls = true;
    video.autoplay = false;

    const btn = document.createElement('button');
    btn.textContent = '再生';
    btn.disabled = true;

    btn.addEventListener('click', async () => {
        if (!token) return alert("トークンがありません");
        const payload = decodeJwt(token);
        if (!payload || !payload.jstream_registered_tracks) return alert("視聴権限がありません");

        const hasAccess = payload.jstream_registered_tracks[trackId];
        if (!hasAccess) return alert("このトラックの視聴権限がありません");

        try {
            btn.disabled = true;
            btn.textContent = '再生準備中...';

            let sessionUrl = `https://auth.streamtech.cloud/session?token=${token}&stream_id=${trackId}`;
            if (is_debug) sessionUrl += "&is_debug=1";

            const response = await fetch(sessionUrl);
            if (!response.ok) throw new Error('ストリーム取得失敗');
            const data = await response.json();

            // Shaka Playerで再生（シークバー非表示）
            const player = new shaka.Player(video);
            player.configure({
                controlPanelElements: ['play_pause', 'volume', 'fullscreen']
            });
            await player.load(data.playback_url);

            btn.textContent = '再生中';
        } catch (e) {
            console.error("ストリーム取得エラー", e);
            alert("再生に失敗しました。コンソール確認");
            btn.textContent = '再生';
            btn.disabled = false;
        }
    });

    container.appendChild(h3);
    container.appendChild(video);
    container.appendChild(btn);
    document.querySelector('.player-grid-container').appendChild(container);
}

window.onload = () => {
    const getRightsBtn = document.getElementById('get-rights-btn');
    const purchaseBtn = document.getElementById('purchase-btn');

    const tracks = [
        {id: 'd65dac2d-b1fa-44f5-9d25-2c7271862104', title: 'Track 1', poster: 'poster_1.jpg'},
        {id: 'e5284a46-0808-4329-a4ab-685e0d2db588', title: 'Track 2', poster: 'poster_2.jpg'},
        {id: 'f17e2dca-3e56-4d71-99f6-7ba976311b69', title: 'Track 3', poster: 'poster_3.jpg'},
        {id: '072eed0b-8397-4b07-a202-510bce4d6097', title: 'Track 4', poster: 'poster_4.jpg'}
    ];

    tracks.forEach(track => createTrack(track.id, track.title, track.poster));

    getRightsBtn.addEventListener('click', () => {
        if (!token) {
            const url = new URL('https://pretix.eu/pyconjp/oauth2/v1/authorize');
            url.searchParams.set('client_id', CLIENT_ID);
            url.searchParams.set('response_type', 'code');
            url.searchParams.set('scope', 'openid profile email');
            url.searchParams.set('redirect_uri', REDIRECT_URI);
            window.location.href = url.toString();
        }
    });

    if (token) {
        const payload = decodeJwt(token);
        if (payload && payload.has_ticket && payload.jstream_registered_tracks) {
            purchaseBtn.style.pointerEvents = 'none';
            purchaseBtn.style.opacity = 0.5;
            getRightsBtn.style.display = 'none';

            tracks.forEach(track => {
                const video = document.getElementById(track.id);
                if (!video) return;
                const btn = video.nextElementSibling;
                if (btn && btn.tagName.toLowerCase() === 'button') btn.disabled = false;
            });
        }
    }
};
</script>
</body>
</html>
