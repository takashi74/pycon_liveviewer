<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PyCon JP 2025 Live</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  body {
      font-family: 'IBM Plex Sans JP', sans-serif;
  }
</style>
</head>
<body class="bg-slate-900 text-slate-50 min-h-screen flex flex-col">

<header class="bg-slate-800 text-white p-4 flex flex-col sm:flex-row justify-between items-center shadow-lg">
    <h1 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-0">PyCon JP 2025 Live</h1>
    <div class="flex space-x-2">
        <a id="purchase-btn" href="https://pretix.eu/pyconjp/2025/" class="px-4 py-2 rounded-lg font-medium transition-colors duration-200 bg-orange-600 hover:bg-orange-700 text-white" target="_blank">視聴チケット購入</a>
        <button id="get-rights-btn" class="px-4 py-2 rounded-lg font-medium transition-colors duration-200 bg-slate-700 hover:bg-slate-600 text-slate-200">視聴権利の取得</button>
    </div>
</header>

<main class="p-4 grid gap-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3">
    <!-- プレイヤーはここに動的生成 -->
</main>

<script>
const CLIENT_ID = "i0VwMUzGedRaeEq1OVFZ7ez9XGnKeptlTOEK5Nlr";
const REDIRECT_URI = "https://auth.streamtech.cloud/callback";

// URLからis_debugとトークンを取得
const urlParams = new URLSearchParams(window.location.search);
const is_debug = urlParams.get('is_debug') === '1';
let token = urlParams.get('token'); // グローバルスコープで定義

/**
 * JWTをデコードしてペイロードを取得します。
 * @param {string} token
 * @returns {object|null}
 */
function decodeJwt(token) {
    if (!token) return null;
    try {
        const payloadBase64 = token.split('.')[1];
        const payload = JSON.parse(atob(payloadBase64));
        return payload;
    } catch (e) {
        console.error("JWTデコード失敗", e);
        return null;
    }
}

/**
 * HLS動画ソースをセットし、再生を開始します。
 * @param {HTMLVideoElement} video
 * @param {string} url
 */
function setVideoSource(video, url) {
    if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
            video.play().catch(err => console.warn("自動再生できませんでした:", err));
        });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.addEventListener('loadedmetadata', () => video.controls = true);
    } else {
        console.error("HLS非対応ブラウザ");
    }
}

/**
 * 視聴開始ボタンの有効化と外観の更新
 */
function enablePlayButtons() {
    const purchaseBtn = document.getElementById('purchase-btn');
    const getRightsBtn = document.getElementById('get-rights-btn');
    const tracks = [
        {id: '54d5a3f3-08d9-42eb-b047-6f403dda7eb4', title: 'Track 1'},
        {id: 'fc43fba3-9bf5-49b8-a9c2-3174b5d75920', title: 'Track 2'},
        {id: 'c5702855-fe83-49a3-a3eb-ed0e694c739e', title: 'Track 3'},
        {id: '4d0a0296-1b38-4863-8e78-95b201b04418', title: 'Track 4'}
    ];
    
    purchaseBtn.classList.add('opacity-50', 'cursor-not-allowed');
    purchaseBtn.style.pointerEvents = 'none';
    getRightsBtn.style.display = 'none';

    tracks.forEach(track => {
        const btn = document.querySelector(`#${track.id} + button`);
        if (btn) {
            btn.disabled = false;
            btn.classList.remove('bg-slate-700', 'hover:bg-slate-600', 'text-slate-200');
            btn.classList.add('bg-orange-600', 'hover:bg-orange-700', 'text-white');
        }
    });
}

/**
 * トラックごとにプレイヤー要素を作成します。
 * @param {string} trackId
 * @param {string} title
 */
function createTrack(trackId, title) {
    const container = document.createElement('div');
    container.className = 'bg-slate-800 p-4 rounded-xl shadow-xl flex flex-col items-center';

    const h3 = document.createElement('h3');
    h3.className = 'text-lg font-semibold mb-3 text-slate-50';
    h3.textContent = title;

    const video = document.createElement('video');
    video.id = trackId;
    video.poster = 'poster.png';
    video.controls = false;
    video.autoplay = false;
    video.muted = false;
    video.className = 'w-full h-auto rounded-lg shadow-md';

    const btn = document.createElement('button');
    btn.className = 'mt-4 px-6 py-2 rounded-full font-bold transition-all duration-300 transform hover:scale-105 bg-slate-700 hover:bg-slate-600 text-slate-200';
    btn.textContent = '視聴開始';
    btn.disabled = true;

    btn.addEventListener('click', async () => {
        // トークンの有無のみをチェック
        if (!token) {
            alert("再生権限がありません。視聴権利を取得してください。");
            return;
        }

        try {
            btn.disabled = true;
            btn.textContent = '再生準備中...';

            let sessionUrl = `https://auth.streamtech.cloud/verify?token=${token}&stream_id=${trackId}`;
            if (is_debug) {
                sessionUrl += "&is_debug=1";
            }

            const response = await fetch(sessionUrl);
            if (!response.ok) {
                // サーバー側で認証失敗した場合もここでエラーになる
                throw new Error('ストリーム取得失敗');
            }
            const data = await response.json();
            setVideoSource(video, data.playback_url);
            btn.textContent = '再生中';
        } catch (e) {
            console.error("ストリーム取得エラー", e);
            alert("再生に失敗しました。視聴権利があるかご確認ください。");
            btn.textContent = '視聴開始';
            btn.disabled = false;
        }
    });

    container.appendChild(h3);
    container.appendChild(video);
    container.appendChild(btn);
    document.querySelector('main').appendChild(container);
}

// ページ初期化
window.onload = () => {
    const getRightsBtn = document.getElementById('get-rights-btn');
    const purchaseBtn = document.getElementById('purchase-btn');
    
    // 仮のトラック情報
    const tracks = [
        {id: '54d5a3f3-08d9-42eb-b047-6f403dda7eb4', title: 'Track 1'},
        {id: 'fc43fba3-9bf5-49b8-a9c2-3174b5d75920', title: 'Track 2'},
        {id: 'c5702855-fe83-49a3-a3eb-ed0e694c739e', title: 'Track 3'},
        {id: '4d0a0296-1b38-4863-8e78-95b201b04418', title: 'Track 4'}
    ];

    tracks.forEach(track => createTrack(track.id, track.title));

    getRightsBtn.addEventListener('click', () => {
        const url = new URL('https://pretix.eu/pyconjp/oauth2/v1/authorize');
        url.searchParams.set('client_id', CLIENT_ID);
        url.searchParams.set('response_type', 'code');
        url.searchParams.set('scope', 'openid profile email');
        url.searchParams.set('redirect_uri', REDIRECT_URI);
        window.location.href = url.toString();
    });

    if (token) {
        const payload = decodeJwt(token);
        if (payload && payload.has_ticket) {
            enablePlayButtons();
        }
    }
};
</script>
</body>
</html>
